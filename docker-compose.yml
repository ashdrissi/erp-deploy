version: "3.9"

services:
  # --- One-off init (writes common_site_config + creates site) ---
  create-site:
    build: .
    command: /opt/erp-deploy/scripts/create-site.sh
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - REDIS_CACHE=redis://redis-cache:6379/0
      - REDIS_QUEUE=redis://redis-queue:6379/1
      - REDIS_SOCKETIO=redis://redis-socketio:6379/2
      - SOCKETIO_PORT=9000
      - SITE_NAME=${SITE_NAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      - mariadb
      - redis-cache
      - redis-queue
      - redis-socketio
    restart: "no"
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- App (Gunicorn - serves WSGI) ---
  app:
    build: .
    command: /home/frappe/frappe-bench/env/bin/gunicorn -b 0.0.0.0:8000 --workers 4 --timeout 120 frappe.app:application
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - REDIS_CACHE=redis://redis-cache:6379/0
      - REDIS_QUEUE=redis://redis-queue:6379/1
      - REDIS_SOCKETIO=redis://redis-socketio:6379/2
      - SITE_NAME=${SITE_NAME}
      - PORT=8000
    healthcheck:
      test: ["CMD-SHELL", "code=$$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8000/ || true); echo $$code | grep -Eq '^(200|302|401|403|404)$'"]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      create-site:
        condition: service_completed_successfully
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Backend (Nginx - routes /socket.io to websocket) ---
  backend:
    build: .
    command: nginx-entrypoint
    environment:
      - BACKEND=app:8000
      - FRAPPE_SITE_NAME_HEADER=${SITE_NAME}
      - SOCKETIO=websocket:9000
      - UPSTREAM_REAL_IP_ADDRESS=127.0.0.1
      - UPSTREAM_REAL_IP_HEADER=X-Forwarded-For
      - UPSTREAM_REAL_IP_RECURSIVE=off
    volumes:
      - sites:/home/frappe/frappe-bench/sites:ro
    depends_on:
      - app
      - websocket
    networks:
      - default
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"

  # --- WebSocket (for real-time updates) ---
  websocket:
    build: .
    command: node /home/frappe/frappe-bench/apps/frappe/socketio.js
    environment:
      - REDIS_SOCKETIO=redis://redis-socketio:6379/2
    volumes:
      - sites:/home/frappe/frappe-bench/sites
    depends_on:
      create-site:
        condition: service_completed_successfully
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Queue Workers (background jobs) ---
  queue-short:
    build: .
    command: bench worker --queue short
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis://redis-cache:6379/0
      - REDIS_QUEUE=redis://redis-queue:6379/1
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      create-site:
        condition: service_completed_successfully
    networks:
      - default
    labels:
      - "traefik.enable=false"

  queue-default:
    build: .
    command: bench worker --queue default
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis://redis-cache:6379/0
      - REDIS_QUEUE=redis://redis-queue:6379/1
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      create-site:
        condition: service_completed_successfully
    networks:
      - default
    labels:
      - "traefik.enable=false"

  queue-long:
    build: .
    command: bench worker --queue long
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis://redis-cache:6379/0
      - REDIS_QUEUE=redis://redis-queue:6379/1
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      create-site:
        condition: service_completed_successfully
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Scheduler (cron jobs) ---
  scheduler:
    build: .
    command: bench schedule
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis://redis-cache:6379/0
      - REDIS_QUEUE=redis://redis-queue:6379/1
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      create-site:
        condition: service_completed_successfully
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Database (MariaDB) ---
  mariadb:
    image: mariadb:10.6
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=frappe
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Redis Cache ---
  redis-cache:
    image: redis:6.2-alpine
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Redis Queue ---
  redis-queue:
    image: redis:6.2-alpine
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # --- Redis SocketIO ---
  redis-socketio:
    image: redis:6.2-alpine
    networks:
      - default
    labels:
      - "traefik.enable=false"

# --- Volumes ---
volumes:
  sites:
  logs:
  db-data:

# --- Networks ---
networks:
  default:
  coolify:
    external: true
