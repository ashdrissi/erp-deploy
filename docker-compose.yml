services:
  # --- Backend (Gunicorn - serves web requests) ---
  backend:
    build: .
    command: /home/frappe/frappe-bench/env/bin/gunicorn -b 0.0.0.0:8000 --workers 4 --timeout 120 frappe.app:application
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
      - REDIS_SOCKETIO=redis-socketio:6379
      - SITE_NAME=${SITE_NAME}
      - PORT=8000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/method/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      - mariadb
      - redis-cache
      - redis-queue
      - redis-socketio
    networks:
      - default
      - coolify
    # Tell Traefik to route to port 8000
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

  # --- WebSocket (for real-time updates) ---
  websocket:
    build: .
    command: node /home/frappe/frappe-bench/apps/frappe/socketio.js
    environment:
      - REDIS_SOCKETIO=redis-socketio:6379
    volumes:
      - sites:/home/frappe/frappe-bench/sites
    depends_on:
      - redis-socketio
    networks:
      - default

  # --- Queue Workers (background jobs) ---
  queue-short:
    build: .
    command: bench worker --queue short
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      - backend
    networks:
      - default

  queue-default:
    build: .
    command: bench worker --queue default
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      - backend
    networks:
      - default

  queue-long:
    build: .
    command: bench worker --queue long
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      - backend
    networks:
      - default

  # --- Scheduler (cron jobs) ---
  scheduler:
    build: .
    command: bench schedule
    environment:
      - DB_HOST=mariadb
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    depends_on:
      - backend
    networks:
      - default

  # --- Database (MariaDB) ---
  mariadb:
    image: mariadb:10.6
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=frappe
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - default

  # --- Redis Cache ---
  redis-cache:
    image: redis:6.2-alpine
    networks:
      - default

  # --- Redis Queue ---
  redis-queue:
    image: redis:6.2-alpine
    networks:
      - default

  # --- Redis SocketIO ---
  redis-socketio:
    image: redis:6.2-alpine
    networks:
      - default

# --- Volumes ---
volumes:
  sites:
  logs:
  db-data:

# --- Networks ---
networks:
  default:
  coolify:
    external: true
